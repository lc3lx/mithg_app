# ๐ ูุธุงู ุฅุฏุงุฑุฉ ุชุงุฑูุฎ ุงูุฑุณุงุฆู (Message History Management)

## ๐ฏ **ูุธุฑุฉ ุนุงูุฉ**

ูุธุงู ุฅุฏุงุฑุฉ ุชุงุฑูุฎ ุงูุฑุณุงุฆู ูู ุญู ุดุงูู ูุฅุฏุงุฑุฉ ูุญูุธ ุงูุฑุณุงุฆู ูู ุงูุชุทุจูู. ูููุฑ ุงููุธุงู ุขููุงุช ูุฃุฑุดูุฉ ูุญุฐู ุงูุฑุณุงุฆู ุงููุฏููุฉ ุชููุงุฆูุงู ููุญูุงุธ ุนูู ุงูุฃุฏุงุก ูุงููุณุงุญุฉ ุงูุชุฎุฒูููุฉ.

---

## โ๏ธ **ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ**

```javascript
const MESSAGE_HISTORY_CONFIG = {
  KEEP_RECENT_MESSAGES: 100, // ุงูุงุญุชูุงุธ ุจุขุฎุฑ 100 ุฑุณุงูุฉ ููู ูุญุงุฏุซุฉ
  ARCHIVE_AFTER_DAYS: 30, // ุฃุฑุดูุฉ ุงูุฑุณุงุฆู ุงูุฃูุฏู ูู 30 ููู
  DELETE_AFTER_DAYS: 365, // ุญุฐู ุงูุฑุณุงุฆู ุงููุคุฑุดูุฉ ุจุนุฏ ุณูุฉ
  CLEANUP_INTERVAL: 24 * 60 * 60 * 1000, // ุชูุธูู ูููู
};
```

---

## ๐๏ธ **ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ**

### **1. ุฃุฑุดูุฉ ุงูุฑุณุงุฆู ุงููุฏููุฉ**

- ุชุญุฏูุฏ ุงูุฑุณุงุฆู ููุคุฑุดูุฉ ุจุนุฏ ูุชุฑุฉ ุฒูููุฉ ูุญุฏุฏุฉ
- ุงูุญูุงุธ ุนูู ุงูุฑุณุงุฆู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููู ุนุฏู ุนุฑุถูุง ูู ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ

### **2. ุชูุธูู ุงููุญุงุฏุซุงุช**

- ุงูุญูุงุธ ุจุขุฎุฑ ุนุฏุฏ ูุญุฏุฏ ูู ุงูุฑุณุงุฆู ููู ูุญุงุฏุซุฉ
- ุญุฐู ุงูุฑุณุงุฆู ุงููุฏููุฉ ุชููุงุฆูุงู

### **3. ุงูุชูุธูู ุงูุชููุงุฆู**

- ูููุฉ cron ููููุฉ ูุชูุธูู ุงูุฑุณุงุฆู ุงููุฏููุฉ
- ุชุนูู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู ููููุงู

### **4. ุฅุญุตุงุฆูุงุช ููุตูุฉ**

- ุนุฏุฏ ุงูุฑุณุงุฆู ุงูููู ูุงููุดุท ูุงููุคุฑุดู
- ุงููุณุชุฎุฏููู ุงูุฃูุซุฑ ุฅุฑุณุงูุงู ููุฑุณุงุฆู
- ุงููุญุงุฏุซุงุช ุงูุฃูุซุฑ ูุดุงุทุงู

---

## ๐ก **APIs ุงููุชุงุญุฉ**

### **ุฃุฑุดูุฉ ุงูุฑุณุงุฆู ุงููุฏููุฉ**

```
POST /api/v1/admin/messages/archive-old
Authorization: Bearer <admin-token>
Permission: moderateContent

Response:
{
  "message": "Message archiving completed",
  "data": {
    "archived": 150,
    "cleaned": 250,
    "archiveThreshold": 30,
    "cleanupThreshold": 100
  }
}
```

### **ุฅุญุตุงุฆูุงุช ุงูุฑุณุงุฆู**

```
GET /api/v1/admin/messages/stats
Authorization: Bearer <admin-token>
Permission: moderateContent

Response:
{
  "data": {
    "total": 10000,
    "active": 8500,
    "archived": 1500,
    "recent": 1200,
    "chatsWithMostMessages": [...],
    "topMessageSenders": [...],
    "config": {...}
  }
}
```

### **ุชูุธูู ูุญุงุฏุซุฉ ูุญุฏุฏุฉ**

```
POST /api/v1/admin/chats/:id/cleanup-messages
Authorization: Bearer <admin-token>
Permission: moderateContent

Response:
{
  "message": "Chat messages cleanup completed",
  "data": {
    "chatId": "...",
    "cleaned": 45,
    "total": 100,
    "kept": 55
  }
}
```

---

## ๐๏ธ **ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช**

### **ุชุญุฏูุซุงุช ูููุฐุฌ Message:**

```javascript
{
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  isArchived: {
    type: Boolean,
    default: false,
  },
  archivedAt: Date,
}
```

### **ุชุญุฏูุซุงุช ูููุฐุฌ User:**

```javascript
{
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  messageCount: {
    type: Number,
    default: 0,
  },
}
```

### **ุงูููุงุฑุณ ุงูุฌุฏูุฏุฉ:**

- `{ isArchived: 1, archivedAt: 1 }`
- `{ createdAt: 1, isArchived: 1 }`

---

## ๐ง **ุงูุชูููุฐ ุงูุชููุงุฆู**

### **ูููุฉ Cron ุงูููููุฉ:**

```javascript
cron.schedule("0 2 * * *", async () => {
  console.log("Running scheduled message cleanup...");
  // ุชูููุฐ ุฃุฑุดูุฉ ูุชูุธูู ุงูุฑุณุงุฆู ุชููุงุฆูุงู
});
```

### **ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฑุณุงุฆู:**

```javascript
messageSchema.post("save", async function () {
  // ุฒูุงุฏุฉ ุนุฏุงุฏ ุงูุฑุณุงุฆู ูููุณุชุฎุฏู
  await User.findByIdAndUpdate(this.sender, {
    $inc: { messageCount: 1 },
  });
});
```

---

## ๐ **ุงูุฅุญุตุงุฆูุงุช ูุงููุฑุงูุจุฉ**

### **ุงูููุงููุณ ุงููุชุงุญุฉ:**

- **ุนุฏุฏ ุงูุฑุณุงุฆู ุงูููู:** ุฅุฌูุงูู ุงูุฑุณุงุฆู ูู ุงููุธุงู
- **ุงูุฑุณุงุฆู ุงููุดุทุฉ:** ุงูุฑุณุงุฆู ุบูุฑ ุงููุคุฑุดูุฉ
- **ุงูุฑุณุงุฆู ุงููุคุฑุดูุฉ:** ุงูุฑุณุงุฆู ุงููุคุฑุดูุฉ
- **ุงูุฑุณุงุฆู ุงูุฃุฎูุฑุฉ:** ุงูุฑุณุงุฆู ูู ุขุฎุฑ 7 ุฃูุงู
- **ุฃูุซุฑ ุงููุณุชุฎุฏููู ุฅุฑุณุงูุงู:** ุชุตููู ุงููุณุชุฎุฏููู ุญุณุจ ุนุฏุฏ ุงูุฑุณุงุฆู
- **ุฃูุซุฑ ุงููุญุงุฏุซุงุช ูุดุงุทุงู:** ุงููุญุงุฏุซุงุช ุงูุฃูุซุฑ ุฑุณุงุฆู

---

## ๐ **ุตูุงุญูุงุช ุงููุตูู**

### **ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:**

- `moderateContent`: ูููุตูู ูุฌููุน ูุธุงุฆู ุฅุฏุงุฑุฉ ุงูุฑุณุงุฆู
- `monitorChats`: ููุฑุงูุจุฉ ุงููุญุงุฏุซุงุช (ููุฌูุฏ ูุณุจูุงู)

### **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:**

```javascript
if (!req.admin.permissions.moderateContent) {
  return res.status(403).json({
    message: "You don't have permission to manage messages",
  });
}
```

---

## ๐ **ุงูุฃุฏุงุก ูุงูุชุญุณููุงุช**

### **ุชุญุณููุงุช ุงูุฃุฏุงุก:**

- **ุงุณุชุฎุฏุงู Promise.all** ููุนูููุงุช ุงููุชุนุฏุฏุฉ
- **ููุงุฑุณ ูุญุณูุฉ** ููุจุญุซ ุงูุณุฑูุน
- **ุฃุฑุดูุฉ ุฐููุฉ** ูุชุฌูุจ ุญุฐู ุงูุจูุงูุงุช ุงููููุฉ
- **ุชูุธูู ุฏูุฑู** ููุญูุงุธ ุนูู ุงููุณุงุญุฉ

### **ุงุณุชุฎุฏุงู ุงูููุงุฑุฏ:**

- **ุฐุงูุฑุฉ:** ููุฎูุถุฉ - ูุนุงูุฌุฉ ุฏูุนูุฉ ููุฑุณุงุฆู
- **ูุงุนุฏุฉ ุงูุจูุงูุงุช:** ุงุณุชุนูุงูุงุช ูุญุณูุฉ ูุน ููุงุฑุณ
- **CPU:** ูุนุงูุฌุฉ ูู ุงูุฎูููุฉ ูุน cron jobs

---

## โ๏ธ **ููุงุท ูููุฉ**

### **ุงููุณุฎ ุงูุงุญุชูุงุทู:**

- ุชุฃูุฏ ูู ูุฌูุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ูุจู ุชุดุบูู ุงูุชูุธูู ุงููุจูุฑ
- ุงูุฑุณุงุฆู ุงููุญุฐููุฉ ูุง ูููู ุงุณุชุฑุฌุงุนูุง

### **ุงูุชุฎุตูุต:**

- ูููู ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช ูู `MESSAGE_HISTORY_CONFIG`
- ุฅุถุงูุฉ ููุงุนุฏ ุชูุธูู ูุฎุตุตุฉ ุญุณุจ ุงูุญุงุฌุฉ

### **ุงููุฑุงูุจุฉ:**

- ูุฑุงูุจุฉ ุงุณุชุฎุฏุงู ุงููุณุงุญุฉ ุงูุชุฎุฒูููุฉ
- ุชุชุจุน ุนุฏุฏ ุงูุฑุณุงุฆู ุงููุญุฐููุฉ ูุงููุคุฑุดูุฉ
- ูุฑุงูุจุฉ ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐ **ุงูุงุณุชุฎุฏุงู ุงูุนููู**

### **ุณููุงุฑูู ุงูุงุณุชุฎุฏุงู:**

1. **ุงููุณุชุฎุฏู ูุฑุณู ุฑุณุงูุฉ** โ ุฒูุงุฏุฉ ุนุฏุงุฏ ุงูุฑุณุงุฆู
2. **ุงูุฑุณุงุฆู ุชุชุฑุงูู** โ ุงูุชูุธูู ุงูุชููุงุฆู ูุญุงูุธ ุนูู ุงูุญุฏ
3. **ุงูุฑุณุงุฆู ุงููุฏููุฉ ุฌุฏุงู** โ ูุชู ุฃุฑุดูุชูุง ุชููุงุฆูุงู
4. **ุงูุฅุฏุงุฑุฉ ุชุฑูุฏ ุฅุญุตุงุฆูุงุช** โ APIs ูุชุงุญุฉ ูููุฑุงุฌุนุฉ

### **ุงูููุงุฆุฏ:**

- โก **ุฃุฏุงุก ุฃูุถู** ูููุญุงุฏุซุงุช ุงููุดุทุฉ
- ๐พ **ุชูููุฑ ูุณุงุญุฉ** ุชุฎุฒูููุฉ
- ๐ **ุฅุญุตุงุฆูุงุช ุฏูููุฉ** ูููุฑุงูุจุฉ
- ๐ **ุนูู ุชููุงุฆู** ุจุฏูู ุชุฏุฎู ูุฏูู

---

## ๐ฏ **ุงูุฎูุงุตุฉ**

ูุธุงู ุฅุฏุงุฑุฉ ุชุงุฑูุฎ ุงูุฑุณุงุฆู ูููุฑ ุญูุงู ุดุงููุงู ููุดููุฉ ุชุฑุงูู ุงูุฑุณุงุฆู ูุน ุงูุญูุงุธ ุนูู ุงูุฃุฏุงุก ูุงููุฑููุฉ. ุงููุธุงู ูุนูู ุชููุงุฆูุงู ูุน ุฅููุงููุฉ ุงูุชุฏุฎู ุงููุฏูู ุนูุฏ ุงูุญุงุฌุฉ.

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ููุนูู ุจููุงุกุฉ ุนุงููุฉ!** โ๐
